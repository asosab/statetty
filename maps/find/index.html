---
layout:             map
title:              "Resultados de b√∫squeda"
date:               2024-06-28
categories:         mapas,B√∫squedas
description:        "Este mapa muestra resultados de una b√∫squeda en Statetty. Para usarlo conversa con @statettybot en telegram"
tags:               [b√∫squedas,mapa,query,resultados]
published:          true
image:              mapa.png
---

<style>
  #toolbox-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    text-align: center;
    line-height: 38px;
    cursor: pointer;
    z-index: 1000;
    font-size: 18px;
  }
  #toolbox {
    position: absolute;
    top: 60px;
    right: 10px;
    background: white;
    border: 1px solid #ccc;
    padding: 10px;
    display: none;
    z-index: 1000;
    min-width: 220px;
  }
  .search-container {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .search-container span {
    margin-right: 5px;
    font-size: 16px;
  }
  .search-container input {
    flex: 1;
    padding: 3px 5px;
  }
</style>
<div id="toolbox-btn">‚öô</div>
<div id="toolbox">

  <div class="search-container">
    <span>üîç</span>
    <div style="position: relative; flex: 1;">
      <input type="text" id="search-input" placeholder="Buscar..." style="width: 98%; padding-right: -5px;">
      <span id="search-count" style="
        position: absolute;
        right: 0px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        color: #555;
        pointer-events: none;
        display: none;
      "></span>
    </div>
  </div>

  <div id="stats-container" style="font-size: 14px; line-height: 1.4;">
    üèô Total inmuebles: <span id="total-inmuebles">0</span><br>
    üí≤ Precio promedio: USD<span id="precio-promedio">0</span><br>
    üè∑Ô∏è M√°s econ√≥mico: <span id="mas-barato">-</span><br>
    üíé M√°s costoso: <span id="mas-caro">-</span><br>
  </div>

</div>








<div id="mapid"></div> <!-- Div donde se mostrar√° el mapa -->
<div id="loading-indicator">Cargando...</div>
<script>
  var map;
  var locations = [];

  var markers = []; // guardar√° { marker, iconOriginal, dato }
  var resultIcon = new L.Icon({
    iconUrl: '../../assets/images/pointers/pointer_found.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [40, 60],
    iconAnchor: [20, 60],
    popupAnchor: [1, -54],
    shadowSize: [60, 60]
  });

  var urlParams = new URLSearchParams(window.location.search);
  let id = urlParams.get('id');
  let key = urlParams.get('key');
  let pProm = Math.round(urlParams.get('p'));
  let na = urlParams.get('na');
  let ag = urlParams.get('ag');

  if (!id || !key) {
    throw new Error("ID o clave no proporcionados en la URL");
  }

  var valores = 'Sheet1!A2:R';
  var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + id + '/values/' + valores + '?key=' + key;

  // Mostrar indicador de carga
  $('#loading-indicator').show();

  $.getJSON(url, function (data) {
    // Ocultar indicador de carga una vez que se hayan cargado los datos
    $('#loading-indicator').hide();

    $(data.values).each(function () {
      var location = {};
      location.nombre = this[0];
      location.lat = parseFloat(this[1]);
      location.lng = parseFloat(this[2]);
      location.dir = this[3];
      location.URL = this[4];
      location.precio = parseInt(this[15]) || 0;
      location.agente = this[16];
      location.numero = this[17];

      var stringOriginal = this[5] ? this[5] : '';
      let totalChr;
      if (stringOriginal && stringOriginal.length > 0) { totalChr = stringOriginal.length; }
      else { totalChr = 0; }
      var chrMax = 500;
      var faltan = 0;
      if (totalChr > chrMax) { faltan = totalChr - chrMax; }
      var frase = '... (y ' + faltan + ' caracteres m√°s)';
      var stringTruncado = totalChr > chrMax ? stringOriginal.substring(0, chrMax) + frase : stringOriginal;
      location.des = stringTruncado;

      locations.push(location);
    });

    // Calcular centroide y radio si no est√°n en la URL
    var lat = urlParams.get('lat');
    var lng = urlParams.get('lng');
    var radius = urlParams.get('r');

    if (!lat || !lng || !radius) {
      let latSum = 0, lngSum = 0;
      locations.forEach(loc => {
        latSum += loc.lat;
        lngSum += loc.lng;
      });

      lat = latSum / locations.length;
      lng = lngSum / locations.length;

      // Calcular la distancia m√°xima desde el centroide
      let maxDistance = 0;
      locations.forEach(loc => {
        const distance = calculateDH(lat, lng, loc.lat, loc.lng);
        if (distance > maxDistance) { maxDistance = distance;}
      });

      radius = maxDistance * 1000; // Convertir a metros
    }

    // Calcular promedio del precio si no est√° en la URL
    if (isNaN(pProm)||pProm==0) {pProm = calcularPromedio(locations, 'precio');}

    // Encontrar el m√°s barato y el m√°s caro
    let masBarato = locations.reduce((min, loc) => (loc.precio && loc.precio < min.precio ? loc : min), locations[0]);
    let masCaro = locations.reduce((max, loc) => (loc.precio && loc.precio > max.precio ? loc : max), locations[0]);

    // üìä Mostrar estad√≠sticas en el panel
    $('#total-inmuebles').text(locations.length);
    $('#precio-promedio').text(formatNumber(pProm));
    $('#mas-barato').text(`${masBarato.nombre}`);
    $('#mas-caro').text(`${masCaro.nombre}`);

    // Crear el mapa
    var mymap = L.map('mapid');

    // A√±adir capa de OpenStreetMap al mapa
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(mymap);

    // Convertir las coordenadas en un objeto L.latLng
    var circleCenter = L.latLng(lat, lng);

    // A√±adir el c√≠rculo al mapa
    var circle = L.circle(circleCenter, {
      color: 'green',
      weight: 1, // Grosor del borde
      fillOpacity: 0, // Sin relleno
      radius: radius
    }).addTo(mymap);

    // Crear un icono personalizado para la cruz
    var crossIcon = L.icon({
      iconUrl: '../../assets/images/cross_green.png', // Ruta al archivo PNG
      iconSize: [20, 20], // Tama√±o del icono
      iconAnchor: [10, 10], // Punto del icono que se ubicar√° en la coordenada especificada
      popupAnchor: [0, -10] // Punto donde se abrir√° el popup (opcional)
    });

    // A√±adir un marcador con el icono personalizado al centro del c√≠rculo
    var crossMarker = L.marker(circleCenter, { icon: crossIcon }).addTo(mymap);

    function formatNumber(num) { return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ",00"; }
    var pPromFormatted = formatNumber(pProm);

    crossMarker.bindPopup(`Coordenadas: ${lat},${lng}<br>Valor promedio: USD${pPromFormatted}`);

    // Funci√≥n para calcular la distancia usando la f√≥rmula de Haversine
    function calculateDH(lat1, lng1, lat2, lng2) {
      // Convertir las coordenadas a radianes
      const lat1Rad = lat1 * Math.PI / 180;
      const lng1Rad = lng1 * Math.PI / 180;
      const lat2Rad = lat2 * Math.PI / 180;
      const lng2Rad = lng2 * Math.PI / 180;

      // Calcular la diferencia de latitudes y longitudes
      const dLat = lat2Rad - lat1Rad;
      const dLng = lng2Rad - lng1Rad;

      // Calcular la distancia en un plano considerando la esfericidad de la Tierra
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1Rad) * Math.cos(lat2Rad) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      // Calcular la distancia en kil√≥metros usando el radio de la Tierra (6371 km)
      const distance = 6371 * c;

      return distance;
    }

    // Iterar sobre los datos y a√±adir marcadores al mapa
    locations.forEach(function (dato) {
      // Crear marcador y vincular un pop-up con los datos adicionales
      //TODO agregar url completo a c21
      let url = dato.URL;
      if (!dato.URL.includes('http')) {url=`https://c21.com.bo${dato.URL}`}

      var brand;
           if (url.includes("c21.com")) { brand = 'C21'; }
      else if (url.includes("remax")) { brand = 'remax'; }
      else if (url.includes("bieninmuebles")) { brand = 'bieni'; }
      else if (url.includes("elfaro")) { brand = 'elfaro'; }
      else if (url.includes("dueodeinmueble")) { brand = 'IDI'; }
      else if (url.includes("ultracasas")) { brand = 'UC'; }
      else if (url.includes("uno.com")) { brand = 'uno'; }
      else if (url.includes("infocasas.com")) { brand = 'ic'; }

      
      else { brand = 'statetty'; }

      var icon = new L.Icon({
        iconUrl: '../../assets/images/pointers/pointer_' + brand + '.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [40, 60], // [25, 41],
        iconAnchor: [20, 60], // [12, 41],
        popupAnchor: [1, -54], // [1, -34], 
        shadowSize: [60, 60] // [41, 41] 
      });

      var marker = L.marker([dato.lat, dato.lng], { icon }).addTo(mymap);

      var nombre = dato?.agente ? ' ' + dato.agente.split(" ")[0] : '';
      var cel = dato?.numero ? dato.numero.replace(/[^0-9]/g, "") : '';
      let soyNa = na? ` ${na}`:'';
      let deAg = ag? ` de ${ag}`:'';
      let sc = ''; if (na || ag) {sc = ' te escribe, '}
      var msj = `Hola${nombre}, ${soyNa}${deAg}${sc}un gusto saludarte. \nPor favor, podr√≠a enviarme informaci√≥n sobre este inmueble, en caso de que siga disponible` +
        ` (${dato.nombre}) \n\nlink: ${url}\n\nGracias de antemano `+
        `\n\n\n( Mensaje creado con Statetty https://statetty.com )`;
      var msjWhatsapp = `https://wa.me/${cel}?text=${encodeURIComponent(msj)}`;
      var linkWA = cel ? '<br/><a href="' + msjWhatsapp + '" target="_blank">Contacta al captador</a>' : '';

      // Calcular la distancia al centro de la circunferencia en metros
      var distance = Math.round(calculateDH(circleCenter.lat, circleCenter.lng, dato.lat, dato.lng) * 1000);

      // Calcular la diferencia porcentual del precio
      var priceDiffPercent = ((dato.precio - pProm) / pProm) * 100;
      var priceComparison;
      if (priceDiffPercent > 0) {priceComparison = `<span style="color: red;">‚Üë${Math.ceil(priceDiffPercent)}%</span>`;} 
      else {priceComparison = `<span style="color: green;">‚Üì${Math.ceil(Math.abs(priceDiffPercent))}%</span>`;}

      var popupContent = "<b>" + dato.nombre + " (" + distance + "m)</b> " + priceComparison + "<br>" +
        "<b>Direcci√≥n:</b> " + dato.dir + "<br>" +
        "<b>Descripci√≥n:</b> " + dato.des + "<br>" +
        '<a href="' + url + '" target="_blank">Ver p√°gina de la captaci√≥n</a>' +
        linkWA;

      marker.bindPopup(popupContent);
      markers.push({ marker, iconOriginal: icon, dato });
    });

    // Ajustar el mapa para que todos los marcadores sean visibles
    var group = new L.featureGroup(locations.map(function (location) {
      return L.marker([location.lat, location.lng]);
    }));
    mymap.fitBounds(group.getBounds());
  });

  // Funci√≥n para calcular el promedio de una propiedad de un array de objetos
  function calcularPromedio(datos, prop) {
    if (!Array.isArray(datos) || datos.length === 0) { return 0; }
    const datosFiltrados = datos.filter(item => item && typeof item[prop] === 'number' && item[prop] >= 0);
    if (datosFiltrados.length === 0) { return 0; }
    const suma = datosFiltrados.reduce((acc, item) => acc + item[prop], 0);
    return Math.round(suma / datosFiltrados.length);
  }


  $('#toolbox-btn').on('click', function() {$('#toolbox').toggle();});
  $('#search-input').on('input', function() {
    let query = $(this).val().toLowerCase();
    let matchCount = 0;
    markers.forEach(obj => {
      let texto = (obj.dato.des + ' ' + obj.dato.nombre + ' ' + obj.dato.dir).toLowerCase();
      if (query && texto.includes(query)) {
        obj.marker.setIcon(resultIcon);
        obj.marker.setZIndexOffset(1000);
        matchCount++;
      } else {
        obj.marker.setIcon(obj.iconOriginal);
        obj.marker.setZIndexOffset(0);
      }
    });

    if (query) { $('#search-count').text(matchCount).show();} 
    else {$('#search-count').hide();}
  });


</script>



