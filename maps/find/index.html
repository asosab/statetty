---
layout:             map
title:              "Resultados de búsqueda"
date:               2024-06-28
categories:         mapas,Búsquedas
description:        "Este mapa muestra resultados de una búsqueda en Statetty. Para usarlo conversa con @statettybot en telegram"
tags:               [búsquedas,mapa,query,resultados]
published:          true
image:              mapa.png
---

<style>
  /* Botón que abre la caja de herramientas */
  #toolbox-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: 1px solid #ddd;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1200;
    font-size: 18px;
  }
  #toolbox-btn:active { transform: translateY(1px); }

  /* Caja de herramientas oculta por defecto */
  #toolbox {
    position: absolute;
    top: 60px;
    right: 10px;
    width: 280px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 10px;
    z-index: 1199;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    display: none; /* oculto por defecto */
  }
  #toolbox h4 { margin: 0 0 8px 0; font-size: 14px; }
  #search-input { width: 100%; box-sizing: border-box; padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; }
  #toolbox-tools { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
  .tool-item { display: block; width: 100%; text-align: left; padding: 6px 8px; border-radius: 6px; border: 1px solid #f0f0f0; background: #fafafa; }

  /* Tamaño del mapa */
  #mapid { height: 80vh; }
  #loading-indicator { position: absolute; left: 10px; top: 10px; z-index: 1200; background: rgba(255,255,255,0.95); padding: 6px 8px; border-radius: 6px; border: 1px solid #eee; display: none; }
</style>

<div id="mapid"></div> <!-- Div donde se mostrará el mapa -->
<div id="loading-indicator">Cargando...</div>

<!-- Botón para mostrar/ocultar la caja de herramientas -->
<div id="toolbox-btn" role="button" aria-label="Abrir caja de herramientas" title="Herramientas">⚙️</div>

<!-- Caja de herramientas: buscador + contenedor para agregar más herramientas (inicialmente oculta) -->
<div id="toolbox" role="region" aria-label="Caja de herramientas">
  <h4>Caja de herramientas</h4>
  <input type="text" id="search-input" placeholder="Buscar en nombre, dirección o descripción..." aria-label="Buscar" />
  <!-- Aquí se agregarán herramientas adicionales -->
  <div id="toolbox-tools" aria-live="polite">
    <!-- Ejemplo de herramienta añadida por defecto (puedes quitarlo) -->
    <button class="tool-item" id="clear-search">Limpiar búsqueda</button>
  </div>
</div>

<script>
  var map;
  var locations = [];
  var markers = []; // guardará { marker, iconOriginal, dato, zIndexOriginal }
  var resultIcon; // declarado en scope superior para ser accesible por handlers fuera de getJSON
  var resultIconLarge; // idem
  var urlParams = new URLSearchParams(window.location.search);
  let id = urlParams.get('id');
  let key = urlParams.get('key');
  let pProm = Math.round(urlParams.get('p'));
  let na = urlParams.get('na');
  let ag = urlParams.get('ag');

  if (!id || !key) { throw new Error("ID o clave no proporcionados en la URL"); }

  var valores = 'Sheet1!A2:R';
  var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + id + '/values/' + valores + '?key=' + key;

  // Mostrar indicador de carga
  $('#loading-indicator').show();

  $.getJSON(url, function (data) {
    $('#loading-indicator').hide();

    $(data.values).each(function () {
      var location = {};
      location.nombre = this[0];
      location.lat = parseFloat(this[1]);
      location.lng = parseFloat(this[2]);
      location.dir = this[3];
      location.URL = this[4];
      location.precio = parseInt(this[15]) || 0;
      location.agente = this[16];
      location.numero = this[17];
      var stringOriginal = this[5] ? this[5] : '';
      let totalChr = stringOriginal.length || 0;
      var chrMax = 500;
      var faltan = totalChr > chrMax ? totalChr - chrMax : 0;
      var frase = '... (y ' + faltan + ' caracteres más)';
      var stringTruncado = totalChr > chrMax ? stringOriginal.substring(0, chrMax) + frase : stringOriginal;
      location.des = stringTruncado;
      locations.push(location);
    });

    var lat = urlParams.get('lat');
    var lng = urlParams.get('lng');
    var radius = urlParams.get('r');

    if (!lat || !lng || !radius) {
      let latSum = 0, lngSum = 0;
      locations.forEach(loc => { latSum += loc.lat; lngSum += loc.lng; });
      lat = latSum / locations.length;
      lng = lngSum / locations.length;
      let maxDistance = 0;
      locations.forEach(loc => {
        const distance = calculateDH(lat, lng, loc.lat, loc.lng);
        if (distance > maxDistance) { maxDistance = distance; }
      });
      radius = maxDistance * 1000;
    }

    if (isNaN(pProm) || pProm == 0) { pProm = calcularPromedio(locations, 'precio'); }

    var mymap = L.map('mapid');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(mymap);

    var circleCenter = L.latLng(lat, lng);
    var circle = L.circle(circleCenter, { color: 'green', weight: 1, fillOpacity: 0, radius: radius }).addTo(mymap);

    var crossIcon = L.icon({ iconUrl: '../../assets/images/cross_green.png', iconSize: [20, 20], iconAnchor: [10, 10], popupAnchor: [0, -10] });
    var crossMarker = L.marker(circleCenter, { icon: crossIcon }).addTo(mymap);

    /**
     * Formatea número a estilo con puntos miles y ,00 final.
     * @param {number} num
     * @return {string}
     */
    function formatNumber(num) { retu
